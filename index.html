<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Cost Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .mode-active {
            border-color: #10b981;
            background-color: #ecfdf5;
            color: #065f46;
        }
        .mode-active-sla {
            border-color: #7e22ce;
            background-color: #faf5ff;
            color: #581c87;
        }
        
        #receipt-view { display: none; }
        body.view-receipt #app-interface { display: none; }
        body.view-receipt #receipt-view { display: block; }

        #qrModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        #qrModal.active { display: flex; }

        #notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
        }

        .custom-banner-bg {
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 text-slate-800" id="mainBody">

    <div id="notification" class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm tracking-wide"></div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="max-w-2xl mx-auto">
        <header class="text-center mb-6 overflow-hidden rounded-2xl relative transition-all duration-500 bg-white shadow-sm p-6" id="headerContainer">
            <div id="headerImgOverlay" class="absolute inset-0 opacity-0 transition-opacity duration-500 bg-cover bg-center"></div>
            <div class="relative z-10 flex flex-col items-center">
                <h1 id="mainHeader" class="text-3xl font-bold text-slate-900 mb-2">3D Print Price Calculator</h1>
                <p id="subHeader" class="text-emerald-700 font-medium">Asencio Designs | 2026 TECO Rates</p>
            </div>
        </header>

        <div class="flex gap-2 mb-6 nav-buttons">
            <button id="fdmToggle" onclick="setMode('fdm')" class="flex-1 py-3 rounded-xl border-2 font-bold transition-all mode-active">FDM (Bambu P1S)</button>
            <button id="slaToggle" onclick="setMode('sla')" class="flex-1 py-3 rounded-xl border-2 font-bold transition-all border-slate-200 bg-white hover:border-purple-200">SLA (Elegoo Resin)</button>
        </div>

        <div id="calculatorCard" class="card shadow-xl rounded-2xl p-6 md:p-8 border border-emerald-100">
            
            <!-- Logo Upload Section -->
            <div class="mb-8 p-4 border-2 border-dashed border-slate-200 rounded-xl bg-white/50">
                <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Custom Branding (Persistent Logo)</label>
                <div class="flex items-center gap-4">
                    <input type="file" id="logoUpload" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                    <button onclick="document.getElementById('logoUpload').click()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-bold transition-colors">UPLOAD IMAGE</button>
                    <button onclick="clearLogo()" class="text-[10px] font-bold text-red-400 hover:text-red-600">RESET</button>
                    <div id="uploadStatus" class="text-[10px] text-slate-500 italic">Persistent branding</div>
                </div>
            </div>

            <!-- Inputs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label id="materialLabel" class="block text-sm font-semibold mb-2">Printer/Material</label>
                    <select id="materialType" onchange="updatePresets()" class="w-full p-3 border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Power Draw (Watts)</label>
                    <input type="number" id="wattage" value="100" oninput="calculate()" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label id="usageLabel" class="block text-sm font-semibold mb-2">Weight/Volume (g/ml)</label>
                    <input type="number" id="grams" placeholder="e.g. 150" oninput="calculate()" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
                <div>
                    <label id="containerCostLabel" class="block text-sm font-semibold mb-2">Cost ($)</label>
                    <input type="number" id="spoolCost" value="20" oninput="calculate()" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label id="containerSizeLabel" class="block text-sm font-semibold mb-2">Size (kg/L)</label>
                    <input type="number" id="spoolWeight" value="1" step="0.1" oninput="calculate()" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Time (Hrs)</label>
                    <input type="number" id="hours" placeholder="e.g. 5" oninput="calculate()" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Markup (%)</label>
                    <input type="number" id="markup" value="50" oninput="calculate()" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
            </div>

            <div id="fdmOptions" class="mb-6 p-4 bg-emerald-50 border border-emerald-100 rounded-xl">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="postProcessing" onchange="calculate()" class="w-5 h-5 rounded text-emerald-600 mr-3">
                    <span class="text-sm font-bold text-emerald-900">Post-Processing Service (+$2.00)</span>
                </label>
            </div>

            <div id="slaOptions" class="hidden mb-6 space-y-4">
                <div class="p-4 bg-purple-50 border border-purple-100 rounded-xl">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 mb-1 uppercase">Screen Cost</label>
                            <input type="number" id="screenCost" value="115" oninput="calculate()" class="w-full p-2 text-sm border rounded">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 mb-1 uppercase">Screen Life</label>
                            <input type="number" id="screenLife" value="2000" oninput="calculate()" class="w-full p-2 text-sm border rounded">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-indigo-50 border border-indigo-100 rounded-xl">
                    <label class="block text-sm font-bold text-indigo-900 mb-2">Manual Adjustment ($)</label>
                    <input type="number" id="adjustedPrice" value="0" oninput="calculate()" class="w-full p-3 border border-indigo-200 rounded-lg">
                </div>
            </div>

            <div class="space-y-4">
                <div id="priceDisplay" class="bg-emerald-600 rounded-xl p-6 text-center text-white shadow-lg">
                    <div id="salePrice" class="text-5xl font-black">$0.00</div>
                </div>

                <div class="grid grid-cols-2 gap-3 action-buttons">
                    <button onclick="generateShareLink()" class="py-4 bg-slate-800 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px]">COPY LINK</button>
                    <button id="qrBtn" onclick="showQRCode()" class="py-4 bg-emerald-600 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px]">SHOW QR CODE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR MODAL -->
    <div id="qrModal" onclick="closeQRModal()">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4" onclick="event.stopPropagation()">
            <div id="qrcode" class="flex justify-center bg-white p-4 border rounded-2xl mb-6"></div>
            <button onclick="closeQRModal()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold uppercase text-xs tracking-widest">Close</button>
        </div>
    </div>

    <!-- RECEIPT VIEW -->
    <div id="receipt-view" class="max-w-md mx-auto py-10 px-4">
        <div id="receiptCard" class="card shadow-2xl rounded-3xl border relative overflow-hidden bg-white">
            <div id="receiptBanner" class="text-white text-center py-12 relative custom-banner-bg">
                <div id="receiptOverlay" class="absolute inset-0 bg-slate-900/40"></div>
                <div class="relative z-10 flex flex-col items-center">
                    <h2 id="receiptBrand" class="text-2xl font-black uppercase drop-shadow-md">Asencio Designs</h2>
                    <p class="font-bold text-[10px] uppercase tracking-[0.3em] mt-1 opacity-90 drop-shadow-md">3D Print Receipt</p>
                </div>
            </div>
            
            <div class="p-8">
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center pb-2 border-b"><span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Date</span><span id="r-date" class="text-sm font-bold"></span></div>
                    <div class="flex justify-between items-center pb-2 border-b"><span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Technology</span><span id="r-mode" class="text-sm font-bold"></span></div>
                    <div class="flex justify-between items-center pb-2 border-b"><span id="r-mat-label" class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Machine</span><span id="r-selection" class="text-sm font-bold"></span></div>
                </div>

                <div class="rounded-2xl p-6 mb-8 bg-slate-50 border border-slate-100">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-black uppercase tracking-widest">Total Price</span>
                        <span id="r-total" class="text-4xl font-black"></span>
                    </div>
                </div>

                <div class="text-center pt-6 border-t">
                    <p id="r-final-brand" class="text-sm font-black text-slate-900 mt-1 uppercase">Asencio Designs</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'fdm';
        const TOTAL_KWH_RATE = 0.15897;

        const PRESETS = {
            fdm: [{ name: 'PLA', watts: 95 }, { name: 'PETG', watts: 95 }, { name: 'ABS/ASA', watts: 240 }, { name: 'Custom', watts: 100, custom: true }],
            sla: [{ name: 'Saturn 4 Ultra', watts: 144 }, { name: 'Mars 4 Max', watts: 72 }, { name: 'Custom', watts: 120, custom: true }]
        };

        function showToast(message) {
            const toast = document.getElementById('notification');
            if (toast) {
                toast.innerText = message;
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 3000);
            }
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    localStorage.setItem('customLogo', base64);
                    applyBranding(base64);
                    showToast("Custom branding saved to this device!");
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearLogo() {
            localStorage.removeItem('customLogo');
            const headerOverlay = document.getElementById('headerImgOverlay');
            if (headerOverlay) headerOverlay.style.opacity = "0";
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) uploadStatus.innerText = "Logo Cleared";
            showToast("Branding reset");
        }

        function applyBranding(base64) {
            if (!base64) return;
            const headerOverlay = document.getElementById('headerImgOverlay');
            if (headerOverlay) {
                headerOverlay.style.backgroundImage = `url('${base64}')`;
                headerOverlay.style.opacity = "1";
            }
            
            const receiptBanner = document.getElementById('receiptBanner');
            if (receiptBanner) {
                receiptBanner.style.backgroundImage = `url('${base64}')`;
            }
        }

        function setMode(mode) {
            currentMode = mode;
            const isSla = (mode === 'sla');
            
            const fdmToggle = document.getElementById('fdmToggle');
            const slaToggle = document.getElementById('slaToggle');
            const fdmOptions = document.getElementById('fdmOptions');
            const slaOptions = document.getElementById('slaOptions');
            const mainBody = document.getElementById('mainBody');
            const priceDisplay = document.getElementById('priceDisplay');
            const qrBtn = document.getElementById('qrBtn');

            if (fdmToggle) fdmToggle.className = mode === 'fdm' ? "flex-1 py-3 rounded-xl border-2 font-bold transition-all mode-active" : "flex-1 py-3 rounded-xl border-2 font-bold transition-all border-slate-200 bg-white";
            if (slaToggle) slaToggle.className = mode === 'sla' ? "flex-1 py-3 rounded-xl border-2 font-bold transition-all mode-active-sla" : "flex-1 py-3 rounded-xl border-2 font-bold transition-all border-slate-200 bg-white";
            
            if (fdmOptions) fdmOptions.classList.toggle('hidden', isSla);
            if (slaOptions) slaOptions.classList.toggle('hidden', !isSla);
            
            if (mainBody) mainBody.className = isSla ? "bg-purple-950 min-h-screen p-4 md:p-8 text-slate-800" : "bg-slate-50 min-h-screen p-4 md:p-8 text-slate-800";
            if (priceDisplay) priceDisplay.className = isSla ? "bg-purple-700 rounded-xl p-6 text-center text-white shadow-lg" : "bg-emerald-600 rounded-xl p-6 text-center text-white shadow-lg";
            if (qrBtn) qrBtn.className = isSla ? "py-4 bg-purple-700 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px]" : "py-4 bg-emerald-600 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px]";
            
            populateMaterials();
            calculate();
        }

        function populateMaterials() {
            const select = document.getElementById('materialType');
            if (!select) return;
            select.innerHTML = '';
            PRESETS[currentMode].forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.watts;
                opt.innerText = p.name;
                if (p.custom) opt.setAttribute('data-custom', 'true');
                select.appendChild(opt);
            });
            updatePresets();
        }

        function updatePresets() {
            const select = document.getElementById('materialType');
            if (!select) return;
            const selectedOption = select.options[select.selectedIndex];
            const wattageInput = document.getElementById('wattage');
            if (wattageInput && selectedOption) {
                if (!selectedOption.hasAttribute('data-custom')) {
                    wattageInput.value = selectedOption.value;
                    wattageInput.disabled = true;
                } else {
                    wattageInput.disabled = false;
                }
            }
            calculate();
        }

        function calculate() {
            const gInput = document.getElementById('grams');
            const scInput = document.getElementById('spoolCost');
            const swInput = document.getElementById('spoolWeight');
            const hInput = document.getElementById('hours');
            const wInput = document.getElementById('wattage');
            const mInput = document.getElementById('markup');
            const sCostInput = document.getElementById('screenCost');
            const sLifeInput = document.getElementById('screenLife');
            const adjInput = document.getElementById('adjustedPrice');
            const ppInput = document.getElementById('postProcessing');

            const grams = (gInput ? parseFloat(gInput.value) : 0) || 0;
            const spoolCost = (scInput ? parseFloat(scInput.value) : 0) || 0;
            const spoolWeightKg = (swInput ? parseFloat(swInput.value) : 1) || 1;
            const hours = (hInput ? parseFloat(hInput.value) : 0) || 0;
            const wattage = (wInput ? parseFloat(wInput.value) : 0) || 0;
            const markupPercent = (mInput ? parseFloat(mInput.value) : 0) || 0;

            const materialCost = (grams / (spoolWeightKg * 1000)) * spoolCost;
            const electricityCost = (wattage / 1000) * hours * TOTAL_KWH_RATE;

            let extra = 0, maint = 0, adj = 0;
            if (currentMode === 'sla') {
                const sCost = (sCostInput ? parseFloat(sCostInput.value) : 115) || 115;
                const sLife = (sLifeInput ? parseFloat(sLifeInput.value) : 2000) || 2000;
                maint = (sCost / sLife) * hours;
                extra = 10; // Hazmat fee
                adj = (adjInput ? parseFloat(adjInput.value) : 0) || 0;
            } else if (ppInput && ppInput.checked) {
                extra = 2; // Post-processing fee
            }

            const production = materialCost + electricityCost + maint + extra;
            const markup = (production - extra) * (markupPercent / 100);
            const total = production + markup + adj;
            
            const salePriceEl = document.getElementById('salePrice');
            if (salePriceEl) salePriceEl.innerText = '$' + total.toFixed(2);
        }

        function getShareData() {
            const select = document.getElementById('materialType');
            const gInput = document.getElementById('grams');
            const hInput = document.getElementById('hours');
            const pOutput = document.getElementById('salePrice');

            const data = {
                m: currentMode.toUpperCase(), 
                s: select ? select.options[select.selectedIndex].text : "Custom",
                g: gInput ? gInput.value : 0, 
                h: hInput ? hInput.value : 0, 
                p: pOutput ? pOutput.innerText : "$0.00",
                d: new Date().toLocaleDateString()
            };
            return btoa(JSON.stringify(data));
        }

        function generateShareLink() {
            const encoded = getShareData();
            const url = window.location.href.split('?')[0] + "?r=" + encodeURIComponent(encoded);
            navigator.clipboard.writeText(url);
            showToast("Link copied!");
        }

        function showQRCode() {
            const qrContainer = document.getElementById('qrcode');
            if (!qrContainer) return;
            qrContainer.innerHTML = '';
            const encoded = getShareData();
            const url = window.location.href.split('?')[0] + "?r=" + encodeURIComponent(encoded);
            
            try {
                new QRCode(qrContainer, {
                    text: url, width: 220, height: 220,
                    colorDark : "#0f172a", colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
                const qrModal = document.getElementById('qrModal');
                if (qrModal) qrModal.classList.add('active');
            } catch(e) { 
                console.error(e);
                showToast("QR Error: Payload too large"); 
            }
        }

        function closeQRModal() {
            const qrModal = document.getElementById('qrModal');
            if (qrModal) qrModal.classList.remove('active');
        }

        function checkReceiptMode() {
            const savedLogo = localStorage.getItem('customLogo');
            if (savedLogo) applyBranding(savedLogo);

            const urlParams = new URLSearchParams(window.location.search);
            const rData = urlParams.get('r');
            if (!rData) return false;

            try {
                const data = JSON.parse(atob(decodeURIComponent(rData)));
                document.body.classList.add('view-receipt');
                
                const isSla = data.m === 'SLA';
                const banner = document.getElementById('receiptBanner');
                if (banner && !savedLogo) {
                    banner.classList.add(isSla ? 'bg-purple-900' : 'bg-emerald-600');
                }

                const rDate = document.getElementById('r-date');
                const rMode = document.getElementById('r-mode');
                const rSelection = document.getElementById('r-selection');
                const rTotal = document.getElementById('r-total');

                if (rDate) rDate.innerText = data.d;
                if (rMode) rMode.innerText = data.m;
                if (rSelection) rSelection.innerText = data.s;
                if (rTotal) rTotal.innerText = data.p;
                
                return true;
            } catch(e) { return false; }
        }

        window.onload = () => { if (!checkReceiptMode()) setMode('fdm'); };
    </script>
</body>
</html>
