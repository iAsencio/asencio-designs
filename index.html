<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Cost Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .mode-active {
            border-color: #10b981;
            background-color: #ecfdf5;
            color: #065f46;
        }
        .mode-active-sla {
            border-color: #7e22ce;
            background-color: #faf5ff;
            color: #581c87;
        }
        
        #receipt-view { display: none; }
        body.view-receipt #app-interface { display: none; }
        body.view-receipt #receipt-view { display: block; }

        #qrModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        #qrModal.active { display: flex; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 text-slate-800" id="mainBody">

    <!-- APP INTERFACE (Calculator) -->
    <div id="app-interface" class="max-w-2xl mx-auto">
        <header class="text-center mb-6">
            <h1 id="mainHeader" class="text-3xl font-bold text-slate-900 mb-2">3D Print Price Calculator</h1>
            <p id="subHeader" class="text-emerald-700 font-medium">Asencio Designs | 2026 TECO Rates</p>
        </header>

        <div class="flex gap-2 mb-6">
            <button id="fdmToggle" onclick="setMode('fdm')" class="flex-1 py-3 rounded-xl border-2 font-bold transition-all mode-active">FDM (Bambu P1S)</button>
            <button id="slaToggle" onclick="setMode('sla')" class="flex-1 py-3 rounded-xl border-2 font-bold transition-all border-slate-200 bg-white hover:border-purple-200">SLA (Elegoo Resin)</button>
        </div>

        <div id="calculatorCard" class="card shadow-xl rounded-2xl p-6 md:p-8 border border-emerald-100">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label id="materialLabel" class="block text-sm font-semibold mb-2">Filament Type</label>
                    <select id="materialType" onchange="updatePresets()" class="w-full p-3 border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Power Draw (Watts)</label>
                    <input type="number" id="wattage" value="100" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label id="usageLabel" class="block text-sm font-semibold mb-2">Weight/Volume Used (g/ml)</label>
                    <input type="number" id="grams" placeholder="e.g. 150" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
                <div>
                    <label id="containerCostLabel" class="block text-sm font-semibold mb-2">Cost of Spool ($)</label>
                    <input type="number" id="spoolCost" value="20" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label id="containerSizeLabel" class="block text-sm font-semibold mb-2">Total Spool (kg)</label>
                    <input type="number" id="spoolWeight" value="1" step="0.1" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Total Print Time (Hrs)</label>
                    <input type="number" id="hours" placeholder="e.g. 5" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Markup (%)</label>
                    <input type="number" id="markup" value="50" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 outline-none">
                </div>
            </div>

            <div id="fdmOptions" class="mb-6 p-4 bg-emerald-50 border border-emerald-100 rounded-xl">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="postProcessing" class="w-5 h-5 rounded text-emerald-600 mr-3">
                    <span class="text-sm font-bold text-emerald-900">Post-Processing Service</span>
                </label>
            </div>

            <div id="slaOptions" class="hidden mb-6 space-y-4">
                <div class="p-4 bg-purple-50 border border-purple-100 rounded-xl">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 mb-1 uppercase">Screen Cost ($)</label>
                            <input type="number" id="screenCost" value="115" class="w-full p-2 text-sm border rounded">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 mb-1 uppercase">Screen Life (Hrs)</label>
                            <input type="number" id="screenLife" value="2000" class="w-full p-2 text-sm border rounded">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-indigo-50 border border-indigo-100 rounded-xl">
                    <label class="block text-sm font-bold text-indigo-900 mb-2">Adjusted Price ($)</label>
                    <input type="number" id="adjustedPrice" value="0" class="w-full p-3 border border-indigo-200 rounded-lg">
                </div>
            </div>

            <div class="space-y-4">
                <div id="priceDisplay" class="bg-emerald-600 rounded-xl p-6 text-center text-white shadow-lg">
                    <div class="text-sm uppercase tracking-wider font-bold mb-1 opacity-80">Suggested Sale Price</div>
                    <div id="salePrice" class="text-5xl font-black">$0.00</div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="generateShareLink()" class="py-4 bg-slate-800 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                        COPY RECEIPT LINK
                    </button>
                    <button id="qrBtn" onclick="showQRCode()" class="py-4 bg-emerald-600 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1 text-[10px]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                        GENERATE QR
                    </button>
                </div>
                <div id="saveToast" class="hidden text-center text-[10px] text-emerald-600 font-bold uppercase tracking-widest">Link Copied!</div>
            </div>
        </div>
    </div>

    <!-- QR MODAL -->
    <div id="qrModal" onclick="closeQRModal()">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black text-slate-800 mb-2">Scan for Receipt</h3>
            <div id="qrcode" class="flex justify-center bg-white p-4 border rounded-2xl mb-4"></div>
            <button onclick="closeQRModal()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold uppercase text-xs tracking-widest">Close</button>
        </div>
    </div>

    <!-- RECEIPT VIEW -->
    <div id="receipt-view" class="max-w-md mx-auto py-10 px-4">
        <div id="receiptCard" class="card shadow-2xl rounded-3xl border relative overflow-hidden">
            <div id="receiptBanner" class="text-white text-center py-8">
                <h2 id="receiptBrand" class="text-2xl font-black uppercase">Asencio Designs</h2>
                <p class="font-bold text-sm uppercase tracking-widest mt-1 opacity-90">3D Print Receipt</p>
            </div>
            <div class="p-8">
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center pb-2 border-b"><span class="text-xs font-bold text-slate-400">DATE</span><span id="r-date" class="text-sm font-semibold"></span></div>
                    <div class="flex justify-between items-center pb-2 border-b"><span class="text-xs font-bold text-slate-400">MODE</span><span id="r-mode" class="text-sm font-semibold"></span></div>
                    <div class="flex justify-between items-center pb-2 border-b"><span id="r-mat-label" class="text-xs font-bold text-slate-400">FILAMENT</span><span id="r-selection" class="text-sm font-semibold"></span></div>
                    <div class="flex justify-between items-center pb-2 border-b"><span class="text-xs font-bold text-slate-400">USAGE</span><span id="r-usage" class="text-sm font-semibold"></span></div>
                    <div class="flex justify-between items-center pb-2 border-b"><span class="text-xs font-bold text-slate-400">PRINT TIME</span><span id="r-time" class="text-sm font-semibold"></span></div>
                </div>
                <div id="breakdownCard" class="rounded-2xl p-5 mb-8">
                    <h4 id="breakdownHeader" class="text-[10px] font-black uppercase tracking-widest mb-3">Cost Breakdown</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Material</span><span id="r-mat-cost"></span></div>
                        <div class="flex justify-between"><span>Electricity*</span><span id="r-elec-cost"></span></div>
                        <div id="r-hazmat-row" class="hidden flex justify-between"><span>Hazmat Fee</span><span>$10.00</span></div>
                        <div id="r-postproc-row" class="hidden flex justify-between"><span>Post-Process</span><span>$2.00</span></div>
                        <div id="r-sla-custom-row" class="hidden flex justify-between"><span>Process Fee</span><span id="r-sla-custom-total"></span></div>
                        <div id="r-fdm-process-row" class="hidden flex justify-between"><span>Process Fee</span><span id="r-fdm-process-fee"></span></div>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-8"><span class="text-lg font-black uppercase">Total</span><span id="r-total" class="text-3xl font-black"></span></div>
                <div class="text-center pt-4 border-t"><p class="text-[10px] text-slate-400 mb-2">*TECO 2026: $0.15897/kWh</p><p class="text-sm font-bold text-slate-800">Thank you for choosing <span id="r-final-brand">Asencio Designs</span>!</p></div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'fdm';
        const TOTAL_KWH_RATE = 0.15897;

        const PRESETS = {
            fdm: [{ name: 'PLA', watts: 95 }, { name: 'PETG', watts: 95 }, { name: 'ABS/ASA', watts: 240 }, { name: 'Custom', watts: 100, custom: true }],
            sla: [{ name: 'Saturn 4 Ultra', watts: 144 }, { name: 'Mars 4 Max', watts: 72 }, { name: 'Custom', watts: 120, custom: true }]
        };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('fdmToggle').className = mode === 'fdm' ? "flex-1 py-3 rounded-xl border-2 font-bold transition-all mode-active" : "flex-1 py-3 rounded-xl border-2 font-bold transition-all border-slate-200 bg-white hover:border-emerald-200";
            document.getElementById('slaToggle').className = mode === 'sla' ? "flex-1 py-3 rounded-xl border-2 font-bold transition-all mode-active-sla" : "flex-1 py-3 rounded-xl border-2 font-bold transition-all border-slate-200 bg-white hover:border-purple-200";
            document.getElementById('fdmOptions').classList.toggle('hidden', mode === 'sla');
            document.getElementById('slaOptions').classList.toggle('hidden', mode === 'fdm');
            
            const isFdm = (mode === 'fdm');
            document.getElementById('mainHeader').innerText = isFdm ? "3D Print Price Calculator" : "Third Eyed Spaceking 3D";
            document.getElementById('subHeader').innerText = isFdm ? "Asencio Designs | 2026 TECO Rates" : "SLA Cost Analysis | 2026 TECO Rates";
            document.getElementById('mainBody').className = isFdm ? "bg-emerald-50 min-h-screen p-4 md:p-8 text-slate-800" : "bg-purple-50 min-h-screen p-4 md:p-8 text-slate-800";
            document.getElementById('priceDisplay').className = isFdm ? "bg-emerald-600 rounded-xl p-6 text-center text-white shadow-lg" : "bg-purple-700 rounded-xl p-6 text-center text-white shadow-lg";
            document.getElementById('qrBtn').classList.toggle('bg-emerald-600', isFdm);
            document.getElementById('qrBtn').classList.toggle('bg-purple-700', !isFdm);
            
            populateMaterials();
            calculate();
        }

        function populateMaterials() {
            const select = document.getElementById('materialType');
            select.innerHTML = '';
            PRESETS[currentMode].forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.watts;
                opt.innerText = p.name;
                if (p.custom) opt.setAttribute('data-custom', 'true');
                select.appendChild(opt);
            });
            updatePresets();
        }

        function updatePresets() {
            const select = document.getElementById('materialType');
            const selectedOption = select.options[select.selectedIndex];
            const wattageInput = document.getElementById('wattage');
            if (selectedOption && !selectedOption.hasAttribute('data-custom')) {
                wattageInput.value = selectedOption.value;
                wattageInput.disabled = true;
                wattageInput.classList.add('bg-slate-50');
            } else {
                wattageInput.disabled = false;
                wattageInput.classList.remove('bg-slate-50');
            }
            calculate();
        }

        function calculate() {
            const grams = parseFloat(document.getElementById('grams').value) || 0;
            const spoolCost = parseFloat(document.getElementById('spoolCost').value) || 0;
            const spoolWeightKg = parseFloat(document.getElementById('spoolWeight').value) || 1;
            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const wattage = parseFloat(document.getElementById('wattage').value) || 0;
            const markupPercent = parseFloat(document.getElementById('markup').value) || 0;

            const materialCost = (grams / (spoolWeightKg * 1000)) * spoolCost;
            const electricityCost = (wattage / 1000) * hours * TOTAL_KWH_RATE;

            let extra = 0, maint = 0, adj = 0;
            if (currentMode === 'sla') {
                maint = (parseFloat(document.getElementById('screenCost').value) / parseFloat(document.getElementById('screenLife').value)) * hours;
                extra = 10;
                adj = parseFloat(document.getElementById('adjustedPrice').value) || 0;
            } else if (document.getElementById('postProcessing').checked) {
                extra = 2;
            }

            const production = materialCost + electricityCost + maint + extra;
            const markup = (production - extra) * (markupPercent / 100);
            const total = production + markup + adj;
            document.getElementById('salePrice').innerText = '$' + total.toFixed(2);
        }

        function getFullShareUrl() {
            const grams = document.getElementById('grams').value || 0;
            const hours = document.getElementById('hours').value || 0;
            const spoolCost = parseFloat(document.getElementById('spoolCost').value) || 0;
            const spoolWeightKg = parseFloat(document.getElementById('spoolWeight').value) || 1;
            const wattage = parseFloat(document.getElementById('wattage').value) || 0;
            const markupPercent = parseFloat(document.getElementById('markup').value) || 0;

            const matCost = (parseFloat(grams) / (spoolWeightKg * 1000)) * spoolCost;
            const elecCost = (wattage / 1000) * parseFloat(hours) * TOTAL_KWH_RATE;
            
            let extra = 0, mn = 0, adjPrice = parseFloat(document.getElementById('adjustedPrice').value) || 0;
            if (currentMode === 'sla') {
                mn = (parseFloat(document.getElementById('screenCost').value) / parseFloat(document.getElementById('screenLife').value)) * parseFloat(hours);
                extra = 10;
            } else if (document.getElementById('postProcessing').checked) {
                extra = 2;
            }

            const prod = matCost + elecCost + mn + extra;
            const mk = (prod - extra) * (markupPercent / 100);

            const data = {
                m: currentMode.toUpperCase(), 
                s: document.getElementById('materialType').options[document.getElementById('materialType').selectedIndex].text,
                g: grams, // Send pure number string
                h: hours, 
                p: document.getElementById('salePrice').innerText,
                d: new Date().toLocaleDateString(),
                mt: matCost.toFixed(2), 
                el: elecCost.toFixed(2), 
                mk: mk.toFixed(2), 
                mn: mn.toFixed(2), 
                hz: currentMode === 'sla',
                pp: document.getElementById('postProcessing').checked, 
                adj: adjPrice
            };

            const encoded = btoa(JSON.stringify(data));
            return window.location.href.split('?')[0] + "?r=" + encodeURIComponent(encoded);
        }

        function generateShareLink() {
            navigator.clipboard.writeText(getFullShareUrl()).then(() => {
                const t = document.getElementById('saveToast');
                t.classList.remove('hidden');
                setTimeout(() => t.classList.add('hidden'), 2000);
            });
        }

        function showQRCode() {
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: getFullShareUrl(), width: 200, height: 200 });
            document.getElementById('qrModal').classList.add('active');
        }

        function closeQRModal() { document.getElementById('qrModal').classList.remove('active'); }

        function checkReceiptMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const rData = urlParams.get('r');
            if (!rData) return false;

            try {
                const data = JSON.parse(atob(decodeURIComponent(rData)));
                document.body.classList.add('view-receipt');
                
                const isSla = data.m === 'SLA';
                const brand = isSla ? "Third Eyed Spaceking 3D" : "Asencio Designs";
                document.getElementById('receiptBrand').innerText = brand;
                document.getElementById('r-final-brand').innerText = brand;

                if (isSla) {
                    document.body.className = "bg-purple-100 min-h-screen p-4 view-receipt";
                    document.getElementById('receiptBanner').className = "bg-purple-700 text-white text-center py-8";
                    document.getElementById('r-total').className = "text-3xl font-black text-purple-700";
                    document.getElementById('r-hazmat-row').classList.remove('hidden');
                    const totalFees = (parseFloat(data.mn) || 0) + (parseFloat(data.mk) || 0) + (parseFloat(data.adj) || 0);
                    document.getElementById('r-sla-custom-row').classList.remove('hidden');
                    document.getElementById('r-sla-custom-total').innerText = '$' + totalFees.toFixed(2);
                } else {
                    document.body.className = "bg-emerald-50 min-h-screen p-4 view-receipt";
                    document.getElementById('receiptBanner').className = "bg-emerald-600 text-white text-center py-8";
                    document.getElementById('r-total').className = "text-3xl font-black text-emerald-600";
                    document.getElementById('r-fdm-process-row').classList.remove('hidden');
                    document.getElementById('r-fdm-process-fee').innerText = '$' + data.mk;
                    if (data.pp) document.getElementById('r-postproc-row').classList.remove('hidden');
                }

                document.getElementById('r-date').innerText = data.d;
                document.getElementById('r-mode').innerText = data.m;
                document.getElementById('r-selection').innerText = data.s;
                document.getElementById('r-usage').innerText = data.g + (isSla ? 'ml' : 'g');
                document.getElementById('r-time').innerText = data.h + 'hrs';
                document.getElementById('r-mat-cost').innerText = '$' + data.mt;
                document.getElementById('r-elec-cost').innerText = '$' + data.el;
                document.getElementById('r-total').innerText = data.p;
                document.getElementById('r-mat-label').innerText = isSla ? 'PRINTER/RESIN' : 'FILAMENT';
                return true;
            } catch(e) { return false; }
        }

        window.onload = () => { if (!checkReceiptMode()) setMode('fdm'); };
    </script>
</body>
</html>
